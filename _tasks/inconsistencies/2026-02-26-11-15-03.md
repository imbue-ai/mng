# Inconsistencies identified on 2026-02-26-11-15-03

## 1. if/elif chains used for enum dispatch instead of match statements

Description: The style guide mandates using `match` statements with `assert_never` when branching on enum values. Several locations use `if/elif/else` chains for pure enum dispatch instead, while other locations in the codebase correctly use `match`. This is an inconsistency in how enum branching is handled.

Key locations using if/elif instead of match:
- `libs/mng/imbue/mng/hosts/common.py:43-91`: `get_activity_sources_for_idle_mode` dispatches purely on `IdleMode` enum values with a long if/elif chain ending in `raise SwitchError(idle_mode)` instead of `assert_never`.
- `libs/mng/imbue/mng/cli/list.py:783-789,798-804`: Two if/elif/else blocks dispatching on `OutputFormat` enum, using `raise AssertionError(...)` instead of `assert_never`.
- `libs/mng_pair/imbue/mng_pair/api.py:111-117`: Branches on `SyncDirection.FORWARD`/`SyncDirection.REVERSE`/else using if/elif/else.
- `libs/mng/imbue/mng/hosts/host.py:931-936`: Branches on `WorkDirCopyMode` enum using if/elif/else.
- `libs/mng/imbue/mng/api/sync.py:389-396,840-860`: Branches on `SyncMode` enum using if/else.
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:693-714`: Branches on `MngInstallMode` using if/elif/else.

Recommendation: Convert these to `match` statements with `assert_never` in the default case, consistent with how other enum dispatches are handled throughout the codebase.

Decision: Accept

## 2. Dict field naming does not follow `value_by_key` convention

Description: The style guide requires dictionaries and mappings to use `value_by_key` naming. Many dict fields across the codebase use generic names like `tags`, `labels`, `plugins`, `providers`, `commands`, etc., while other dict fields correctly follow the convention (e.g., `width_by_field` in `list.py`). This creates an inconsistency in naming.

Key violations:
- `libs/mng/imbue/mng/config/data_types.py:435`: `agent_types: dict[AgentTypeName, AgentTypeConfig]` (should be `config_by_agent_type`)
- `libs/mng/imbue/mng/config/data_types.py:439`: `providers: dict[ProviderInstanceName, ProviderInstanceConfig]` (should be `config_by_provider`)
- `libs/mng/imbue/mng/config/data_types.py:443`: `plugins: dict[PluginName, PluginConfig]` (should be `config_by_plugin`)
- `libs/mng/imbue/mng/config/data_types.py:451`: `commands: dict[str, CommandDefaults]` (should be `defaults_by_command`)
- `libs/mng/imbue/mng/interfaces/data_types.py:478`: `labels: dict[str, str]` (should be `value_by_label`)
- `libs/mng/imbue/mng/interfaces/data_types.py:428,374,312`: `tags: dict[str, str]` in multiple data types (should be `value_by_tag`)
- `libs/mng/imbue/mng/api/list.py:253`, `libs/mng/imbue/mng/api/message.py:69`: `provider_map = {...}` (should be `provider_by_name`)
- `libs/mng/imbue/mng/utils/logging.py:144,413,503`: `level_map = {...}` (should be `loguru_level_by_log_level`)
- `libs/mng/imbue/mng/providers/ssh/config.py:30`, `libs/mng/imbue/mng/providers/ssh/instance.py:48`: `hosts: dict[str, SSHHostConfig]` (should be `config_by_host_name`)

Recommendation: Rename dict fields and variables to follow the `value_by_key` convention. This is a large change that should be done incrementally, starting with the most widely-used fields in `config/data_types.py` and `interfaces/data_types.py`.

Decision: Accept

## 3. Variable reassignment inside @pure-decorated functions

Description: The style guide says to never reassign to the same function-scoped variable, and instead create new variables with updated names. Two `@pure`-decorated functions reassign variables, which is inconsistent with both the functional style and the `@pure` contract.

- `libs/mng/imbue/mng/cli/connect.py:60-76`: `filter_agents` (decorated `@pure`) reassigns `result` three times: initialized from `agents`, then conditionally reassigned in two if-blocks.
- `libs/mng/imbue/mng/api/logs.py:300-316`: `apply_head_or_tail` (decorated `@pure`) reassigns `lines` twice: first from `content.splitlines()`, then conditionally sliced.

Recommendation: Refactor to avoid reassignment. For `filter_agents`, use separate variable names (e.g., `active_agents`, `filtered_agents`). For `apply_head_or_tail`, use a ternary or separate named results for each branch.

Decision: Accept

## 4. Interface classes defined outside `interfaces/` module

Description: The style guide says interface classes should be in `interfaces.py` or an `interfaces/` module. Two interface classes are defined in unexpected locations, while all other interfaces are correctly placed in `libs/mng/imbue/mng/interfaces/`.

- `libs/mng/imbue/mng/api/sync.py:135`: `GitContextInterface(MutableModel, ABC)` is defined in the API layer rather than in `interfaces/`.
- `libs/mng/imbue/mng/cli/ask.py:182`: `ClaudeBackendInterface(MutableModel, ABC)` is defined in the CLI layer rather than in `interfaces/`.

Recommendation: Move both interface classes to the `interfaces/` module (or a new file within it) and import them where needed.

Decision: Accept

## 5. Internal boolean fields missing `is_` prefix

Description: The style guide requires internal boolean variables to be prefixed with `is_`. Several internal model fields use boolean types without this prefix, while many other fields in the same codebase correctly follow the convention (e.g., `is_initialized`, `is_completed`, `is_verbose_mode`). Per non_issues.md, CLI option fields are exempt.

Key violations (non-CLI internal fields):
- `libs/mng/imbue/mng/interfaces/data_types.py:182`: `success: bool` on `CommandResult` (should be `is_success`)
- `libs/mng/imbue/mng/interfaces/data_types.py:463`: `start_on_boot: bool` on `AgentInfo` (should be `is_start_on_boot`)
- `libs/mng/imbue/mng/config/data_types.py:251`: `enabled: bool` on `PluginConfig` (should be `is_enabled`)
- `libs/mng/imbue/mng/api/exec.py:34`: `success: bool` on `ExecResult` (should be `is_success`)
- `libs/mng/imbue/mng/api/data_types.py:312`: `create_work_dir: bool` on `CreateHostAndAgentOptions` (should be `is_create_work_dir`)
- `libs/mng/imbue/mng/agents/default_plugins/claude_agent.py:73-98`: Six boolean fields on `ClaudeAgentConfig` without `is_` prefix: `sync_home_settings`, `sync_claude_json`, `sync_repo_settings`, `sync_claude_credentials`, `convert_macos_credentials`, `check_installation`
- `libs/mng/imbue/mng/providers/modal/instance.py:422`: `offline: bool` on `ModalInstanceConfig` (should be `is_offline`)

Recommendation: Add the `is_` prefix to these internal boolean fields. The `ClaudeAgentConfig` fields are the highest priority since there are six violations in one class.

Decision: Accept

## 6. FrozenModel subclasses scattered outside `data_types.py`

Description: The style guide says frozen objects should be in `data_types.py` (or a `data_types/` module). While many FrozenModel classes are correctly placed, a significant number are defined in other files. This creates inconsistency in where to find data type definitions.

Key locations with misplaced FrozenModel classes:
- `libs/mng/imbue/mng/interfaces/host.py:460-687`: 12 FrozenModel subclasses (`CreateWorkDirResult`, `AgentGitOptions`, `AgentEnvironmentOptions`, `AgentLifecycleOptions`, `AgentLabelOptions`, `UploadFileSpec`, `FileModificationSpec`, `AgentProvisioningOptions`, `NamedCommand`, `AgentDataOptions`, `AgentOptions`, `AgentPermissionsOptions`) defined in `host.py` instead of `interfaces/data_types.py`.
- `libs/mng/imbue/mng/api/find.py:35,417`: `ParsedSourceLocation`, `AgentMatch`
- `libs/mng/imbue/mng/api/exec.py:28`: `ExecResult`
- `libs/mng/imbue/mng/api/logs.py:36,58`: `LogsTarget`, `LogFileEntry`
- `libs/mng/imbue/mng/api/sync.py:78,104`: `SyncFilesResult`, `SyncGitResult`
- `libs/mng/imbue/mng/cli/create.py:1509`: `ParsedSourceString`
- `libs/mng/imbue/mng/cli/plugin.py:65,432,438,444`: `PluginInfo`, `_PypiSource`, `_PathSource`, `_GitSource`
- `libs/mng/imbue/mng/hosts/host.py:111`: `HostLocation`
- `libs/mng/imbue/mng/utils/deps.py:10`: `SystemDependency`
- `libs/mng/imbue/mng/utils/logging.py:264`: `BufferedMessage`
- `libs/mng/imbue/mng/providers/modal/instance.py:447,467`: `HostRecord`, `ModalProviderApp`

Recommendation: Consolidate FrozenModel classes into the appropriate `data_types.py` files. The 12 classes in `interfaces/host.py` should be moved to `interfaces/data_types.py` first as the highest-impact change.

Decision: Accept

## 7. Mutable input parameter types (list/dict instead of Sequence/Mapping)

Description: The style guide requires function inputs to use immutable abstract types (`Sequence[T]` instead of `list[T]`, `Mapping[K, V]` instead of `dict[K, V]`). Some functions follow this correctly (e.g., functions in `list.py` use `Sequence[str]` for `fields`), while adjacent functions in the same files use `list` and `dict`.

Key inconsistencies:
- `libs/mng/imbue/mng/cli/list.py:716,727`: `_format_streaming_header_row` and `_format_streaming_agent_row` correctly use `Sequence[str]` for `fields` but use `dict[str, int]` for `column_widths` (should be `Mapping[str, int]`).
- `libs/mng/imbue/mng/cli/list.py:811,834,864,971`: `_emit_json_output`, `_emit_human_output`, `_emit_template_output`, `_sort_agents` all take `list[AgentInfo]` (should be `Sequence[AgentInfo]`).
- `libs/mng/imbue/mng/cli/connect.py:62`: `filter_agents` takes `list[AgentInfo]` (should be `Sequence[AgentInfo]`).
- `libs/mng/imbue/mng/cli/cleanup.py:463,577`: `_run_cleanup_selector` and `_emit_dry_run_output` take `list[AgentInfo]`.
- `libs/mng/imbue/mng/config/data_types.py:75,87`: `merge_list_fields(base: list[T], ...)` and `merge_dict_fields(base: dict[K, V], ...)` should use `Sequence`/`Mapping`.

Recommendation: Update parameter types to use immutable abstract types. Start with the CLI layer (`list.py`, `connect.py`, `cleanup.py`) where the pattern is most visibly inconsistent (some params use `Sequence`, others use `list` in the same file).

Decision: Accept

## 8. Missing `Final` annotation on module-level constants

Description: The style guide requires all constants to be declared `Final`. Some constants correctly use `Final` (e.g., `_PROCESS_WAIT_TIMEOUT_SECONDS: Final[int]` in `cli/ask.py`), while many others in the same or adjacent files omit it.

Key violations:
- `libs/mng/imbue/mng/utils/logging.py:30-35`: `WARNING_COLOR`, `ERROR_COLOR`, `BUILD_COLOR`, `DEBUG_COLOR`, `TRACE_COLOR`, `RESET_COLOR` all lack `Final[str]`, while `BUILD_LEVEL_NO` on line 38 correctly uses `Final[int]`.
- `libs/mng/imbue/mng/utils/deps.py:35,42,49,56`: `RSYNC`, `TMUX`, `GIT`, `JQ` lack `Final`.
- `libs/mng/imbue/mng/main.py:53,318`: `COMMAND_ALIASES` and `BUILTIN_COMMANDS` lack `Final`.
- `libs/mng/imbue/mng/hosts/host.py:2124,2144`: `ONBOARDING_TEXT` and `ONBOARDING_TEXT_TMUX_USER` lack `Final[str]`.
- `libs/mng/imbue/mng/cli/common_opts.py:39`: `COMMON_OPTIONS_GROUP_NAME` lacks `Final[str]`.
- `libs/imbue_common/imbue/imbue_common/ratchet_testing/common_ratchets.py:54-300`: All `PREVENT_*` constants lack `Final`.

Recommendation: Add `Final` type annotations to all module-level constants. The `logging.py` file is the most striking because the same file has both `Final` and non-`Final` constants.

Decision: Accept

## 9. Raw BaseModel used instead of FrozenModel

Description: One class in the codebase inherits directly from `BaseModel` instead of `FrozenModel`, which is inconsistent with every other data container class.

- `libs/mng/imbue/mng/cli/list.py:739`: `_ListIterationParams(BaseModel)` with manual `model_config = {"arbitrary_types_allowed": True}`. This is a frozen-style data container (all fields, no methods) that should inherit from `FrozenModel`.

Recommendation: Change `_ListIterationParams` to inherit from `FrozenModel`. If `arbitrary_types_allowed` is needed, configure it via the `FrozenModel` config mechanism.

Decision: Accept

## 10. Raw `model_copy(update=...)` instead of type-safe `model_copy_update`

Description: The style guide mandates using the type-safe `model_copy_update`/`to_update`/`field_ref` pattern. One location uses the raw string-based `model_copy(update={"field": value})` pattern, while all other model copy operations correctly use the type-safe approach.

- `apps/changelings/imbue/changelings/cli/add.py:135`: `definition = definition.model_copy(update={"mng_profile": resolved_profile})` should use `definition.model_copy_update(to_update(definition.field_ref().mng_profile, resolved_profile))`.

Recommendation: Replace with the type-safe `model_copy_update` pattern.

Decision: Accept

## 11. Built-in exceptions raised directly instead of project-specific subclasses

Description: The style guide requires all raised exceptions to inherit from a library-specific base class (except `NotImplementedError`). Several locations raise bare built-in exceptions, while most of the codebase correctly uses project-specific error types.

Key violations:
- `libs/mng/imbue/mng/providers/base_provider.py:52`: `raise Exception("Offline hosts not supported...")` -- bare `Exception`.
- `libs/mng/imbue/mng/providers/local/instance.py:247`: `raise Exception("delete_host should not be called...")` -- bare `Exception`.
- `libs/mng/imbue/mng/hosts/host.py:299`: `raise FileNotFoundError(...)` -- should be a project-specific subclass inheriting both `BaseMngError` and `FileNotFoundError`.
- `libs/mng/imbue/mng/providers/docker/volume.py:109,144`: `raise FileNotFoundError(...)` -- same issue, two locations.
- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:636`: `raise ValueError(...)` -- should be a `ConcurrencyGroupError` subclass.
- `apps/changelings/imbue/changelings/deploy/cron_runner.py:60,226,409`: bare `Exception` and `RuntimeError` raises.

Additionally, `libs/imbue_common` lacks a library-wide base error class. Exception classes like `InvalidRandomIdError(ValueError)` in `ids.py`, `NestedFieldUpdateError(ValueError)` in `model_update.py`, and `InvalidProbabilityError(ValueError)` in `primitives.py` all inherit only from built-in types.

Recommendation: Create project-specific error subclasses for each case. For `imbue_common`, consider adding a `ImbueCommonError(Exception)` base class.

Decision: Accept

## 12. Enum in claude_web_view uses wrong base class and hardcoded values

Description: All enums in the codebase use `UpperCaseStrEnum` with `auto()` values, except one.

- `apps/claude_web_view/imbue/claude_web_view/models.py:9-14`: `MessageRole(str, Enum)` inherits from `str, Enum` directly instead of `UpperCaseStrEnum`, and uses hardcoded lowercase string values (`"user"`, `"assistant"`, `"system"`) instead of `auto()`.

Recommendation: Change to inherit from `UpperCaseStrEnum` and use `auto()` for all values. If the lowercase string values are required for API compatibility, add a serialization/deserialization layer.

Decision: Accept

## 13. Inline import in subprocess_utils.py without circular-import justification

Description: The style guide prohibits inline imports. Most imports in the codebase are at the module level. One inline import has no circular-import justification.

- `libs/concurrency_group/imbue/concurrency_group/subprocess_utils.py:44`: `from imbue.concurrency_group.errors import ProcessError` is imported inline inside the `check()` method. The same file already imports `ProcessTimeoutError` and `ProcessSetupError` from the same module at the top level (line 7-8). There is no circular dependency -- `ProcessError` could be added to the existing module-level imports.

Other inline imports in the codebase (`snapshot_and_shutdown.py`, `deploy.py`, `latency_check.py`) have legitimate justifications (Modal runtime isolation, circular dependency breaking).

Recommendation: Move the `ProcessError` import to the module level alongside the existing imports from the same module.

Decision: Accept
