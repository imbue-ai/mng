# Inconsistencies identified on 2026-02-26-03-21-43

## 1. unittest.mock and monkeypatch.setattr used in tests

Description: The style guide explicitly prohibits `unittest.mock` (Mock, MagicMock, patch) and `monkeypatch.setattr` in tests. However, several test files violate this:

- `libs/mng/imbue/mng/providers/modal/instance_test.py:9-10` uses `from unittest.mock import MagicMock` and `from unittest.mock import patch`
- `libs/mng/imbue/mng/agents/default_plugins/claude_agent_test.py:8` uses `from unittest.mock import patch`
- `libs/mng/imbue/mng/cli/issue_reporting_test.py` has 16 uses of `monkeypatch.setattr`
- `libs/mng/imbue/mng/cli/ask_test.py` has 2 uses of `monkeypatch.setattr`
- `libs/mng/imbue/mng/api/connect_test.py` has 2 uses of `monkeypatch.setattr`
- `libs/mng_pair/imbue/mng_pair/test_api.py` has 2 uses of `monkeypatch.setattr`
- `libs/mng/imbue/mng/cli/test_agent_utils.py` has 2 uses of `monkeypatch.setattr`

Recommendation: Replace `unittest.mock` usage with concrete mock implementations that inherit from the relevant interfaces. Replace `monkeypatch.setattr` calls with dependency injection or concrete mock implementations. The style guide says `monkeypatch.setenv`/`monkeypatch.delenv`/`monkeypatch.chdir` are fine, but `monkeypatch.setattr` is not.

Decision: Accept

## 2. Raw model_copy(update=...) instead of type-safe model_copy_update

Description: The style guide requires using the type-safe `model_copy_update`/`to_update`/`field_ref` pattern instead of raw `model_copy(update={...})`. Two files violate this:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:658`: `trigger = trigger.model_copy(update={"git_image_hash": commit_hash})`
- `apps/changelings/imbue/changelings/cli/add.py:135`: `definition = definition.model_copy(update={"mng_profile": resolved_profile})`

These use string-based field names, which are not checked by the type system and will silently break if fields are renamed.

Recommendation: Convert both to use the type-safe pattern: `trigger.model_copy_update(to_update(trigger.field_ref().git_image_hash, commit_hash))` and similarly for the changelings case.

Decision: Accept

## 3. claude_web_view app does not follow project conventions

Description: The `apps/claude_web_view` app has multiple deviations from the codebase style guide:

- `models.py:9`: `MessageRole(str, Enum)` uses `str, Enum` instead of `UpperCaseStrEnum` and has lowercase values (`"user"`, `"assistant"`, `"system"`) instead of `auto()`
- `models.py:18,25,34,46,55,64,72,79,87`: All model classes use `BaseModel` instead of `FrozenModel`
- `server.py:15-16`, `watcher.py:8`, `cli.py:10`, `parser.py:6-12`: Use relative imports (`from .parser import ...`) instead of absolute imports
- `watcher.py:35`: Uses bare `except Exception: pass` which silently swallows all errors

Recommendation: Refactor to use `UpperCaseStrEnum` with `auto()` for `MessageRole`, use `FrozenModel` for immutable data types, convert all relative imports to absolute imports, and add proper error handling in `watcher.py`.

Decision: Accept

## 4. RuntimeError raised directly in cron runner modules instead of custom exceptions

Description: The style guide says to never raise built-in exceptions directly (except `NotImplementedError`) and instead create custom exception types. Several cron runner files raise `RuntimeError` directly:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/cron_runner.py:51`: `raise RuntimeError(f"{name} must be set")`
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/cron_runner.py:152`: `raise RuntimeError(f"Command failed with exit code {process.returncode}: {cmd}")`
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/cron_runner.py:229`: `raise RuntimeError(f"mng {command} failed with exit code {exit_code}")`
- `apps/changelings/imbue/changelings/deploy/cron_runner.py:226`: `raise RuntimeError(f"Command failed with exit code {process.returncode}: {cmd}")`
- `apps/changelings/imbue/changelings/deploy/cron_runner.py:409`: `raise RuntimeError(f"Remote runner failed with exit code {exit_code}")`

Recommendation: Create custom exception classes (e.g., `CronRunnerError` inheriting from both the library's base error class and `RuntimeError`) and use those instead.

Decision: Accept

## 5. Constants missing Final annotation in logging.py

Description: The style guide says all constants should be declared as `Final`. In `libs/mng/imbue/mng/utils/logging.py:30-35`, six color constants are module-level UPPER_CASE constants but lack the `Final` annotation:

- `WARNING_COLOR = "\x1b[1;38;5;178m"` (line 30)
- `ERROR_COLOR = "\x1b[1;38;5;196m"` (line 31)
- `BUILD_COLOR = "\x1b[38;5;245m"` (line 32)
- `DEBUG_COLOR = "\x1b[38;5;33m"` (line 33)
- `TRACE_COLOR = "\x1b[38;5;99m"` (line 34)
- `RESET_COLOR = "\x1b[0m"` (line 35)

Notably, the equivalent file in changelings (`apps/changelings/imbue/changelings/utils/logging.py:21-22`) correctly uses `Final[str]` for its color constants, making this inconsistency between the two logging modules even more evident.

Recommendation: Add `Final[str]` type annotation to all six constants, matching the pattern used in the changelings app.

Decision: Accept

## 6. ValueError raised directly in mng_schedule deploy.py

Description: `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py` raises bare `ValueError` three times at lines 316, 320, and 322 for upload spec validation, instead of using a custom exception class that inherits from the library's base error:

- Line 316: `raise ValueError(f"Upload spec must be in SOURCE:DEST format, got: {spec}")`
- Line 320: `raise ValueError(f"Upload source does not exist: {source_str}")`
- Line 322: `raise ValueError(f"Upload destination must be relative or start with '~', got: {dest}")`

Recommendation: Create a `DeployValidationError` (or similar) class in mng_schedule's errors module that inherits from both the base error and `ValueError`, and use it here.

Decision: Accept

## 7. global keyword usage

Description: The style guide says to avoid using the `global` keyword and instead pass state explicitly. Two files use it:

- `apps/sculptor_web/imbue/sculptor_web/main.py:149,160`: `global _poll_thread` (used twice)
- `libs/imbue_common/imbue/imbue_common/conftest_hooks.py:596`: `global _registered`

Recommendation: Refactor `sculptor_web/main.py` to pass the poll thread through function parameters or encapsulate it in a class. The `conftest_hooks.py` usage in a test configuration helper is more defensible but should still be refactored if feasible.

Decision: Accept

## 8. Inconsistent if/elif on enum values instead of match statements

Description: The style guide says to always use match statements when branching on enum values. Two non-test files use if/elif chains on enums instead:

- `libs/mng/imbue/mng/cli/list.py:783-789` and `798-804`: Two if/elif chains branching on `OutputFormat` enum with `else: raise AssertionError(...)` instead of using a match statement with `assert_never`
- `libs/mng_pair/imbue/mng_pair/api.py:111-118`: If/elif chain branching on `SyncDirection` enum

Recommendation: Convert these if/elif chains to match statements with `assert_never` in the default case, consistent with the rest of the codebase (which has 40+ correct match/assert_never usages).

Decision: Accept

## 9. Broad except Exception clauses that silently swallow errors

Description: The style guide says to be very conservative with what exceptions are caught and to always catch the narrowest specific exception type. Two files silently swallow all exceptions:

- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:233`: `except Exception: pass` during thread join -- all errors are silently ignored
- `apps/claude_web_view/imbue/claude_web_view/watcher.py:35`: `except Exception: pass` during event broadcasting -- all errors are silently ignored

Recommendation: Narrow the exception type to the specific exceptions that are expected (e.g., `ConnectionError`, `BrokenPipeError`), or at minimum log the exception at warning/debug level before continuing.

Decision: Accept

## 10. Large try/except block in snapshot_and_shutdown.py

Description: The style guide says each try/except block should only span a single statement. `libs/mng/imbue/mng/providers/modal/routes/snapshot_and_shutdown.py:123-153+` has a try block spanning ~27 statements that mixes validation, I/O, and state changes. This makes it unclear what exceptions each section might throw and what recovery should happen at each step.

Recommendation: Break this into separate try/except blocks per logical operation: one for request validation, one for host record lookup, one for sandbox retrieval, one for snapshot creation, and one for state persistence.

Decision: Accept
