# Inconsistencies identified on 2026-02-26-14-16-19

## 1. Enum comparisons use if/elif chains instead of match statements

Description: The style guide states "For enums, always use match statements." Several functions compare enum values using if/elif chains instead. These are:

- `libs/mng/imbue/mng/hosts/common.py:38` - `get_activity_sources_for_idle_mode()` compares `IdleMode` enum values via a 9-branch if/elif chain. This function is also missing the `@pure` decorator despite being a pure data transformation.
- `libs/mng/imbue/mng/cli/list.py:779-804` - Two if/elif chains compare `OutputFormat` enum (lines 783 and 798).
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:762-783` - if/elif chain compares `MngInstallMode` enum values. The `else` branch handles the PACKAGE case with a comment, but this should be an explicit `case MngInstallMode.PACKAGE:` in a match statement.

Recommendation: Convert all enum comparisons to match statements with `case _ as unreachable: assert_never(unreachable)` for exhaustiveness checking.

Decision: Accept

## 2. Bare `case _:` default in match statement on enum instead of assert_never

Description: In `libs/mng/imbue/mng/providers/modal/volume.py:54-58`, the function `_modal_file_type_to_volume_file_type()` uses a match statement on `FileEntryType` (from the modal library) with a bare `case _:` fallback instead of `case _ as unreachable: assert_never(unreachable)`. While `FileEntryType` is a third-party enum, the style guide requires explicit exhaustiveness. If new file types are added to modal, this code would silently treat them as FILE without any warning.

```python
match modal_type:
    case FileEntryType.DIRECTORY:
        return VolumeFileType.DIRECTORY
    case _:
        return VolumeFileType.FILE
```

Recommendation: Enumerate all known `FileEntryType` values explicitly and use `assert_never` for the default case, or at minimum log a warning when encountering an unknown type.

Decision: Accept

## 3. Unsafe `model_copy(update={...})` instead of type-safe `model_copy_update`

Description: The style guide explicitly states "Never pass raw string dictionaries like `model_copy(update={"field_name": value})` -- always use the type-safe pattern." Three call sites bypass the type-safe pattern:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:715` - `trigger.model_copy(update={"git_image_hash": head_hash})`
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:726` - `trigger.model_copy(update={"git_image_hash": commit_hash})`
- `apps/changelings/imbue/changelings/cli/add.py:135` - `definition.model_copy(update={"mng_profile": resolved_profile})`

Recommendation: Replace all three with the `model_copy_update(to_update(obj.field_ref().field, value))` pattern.

Decision: Accept

## 4. Raw BaseModel usage instead of FrozenModel/MutableModel

Description: The style guide requires data classes to inherit from `FrozenModel` or `MutableModel`, never raw `BaseModel`. The following class uses `BaseModel` directly in the main library:

- `libs/mng/imbue/mng/cli/list.py:739` - `class _ListIterationParams(BaseModel)` with `model_config = {"arbitrary_types_allowed": True}`. This should be a `FrozenModel` (with `arbitrary_types_allowed` set in the ConfigDict if needed).

Additionally, `apps/claude_web_view/imbue/claude_web_view/models.py` contains 10 classes inheriting from `BaseModel` instead of `FrozenModel` (lines 18, 25, 34, 46, 55, 64, 72, 79, 87) and `apps/claude_web_view/imbue/claude_web_view/server.py:19` has one more (`SendMessageRequest`).

Recommendation: Convert `_ListIterationParams` to `FrozenModel`. Convert claude_web_view models to `FrozenModel`.

Decision: Accept

## 5. Enum in claude_web_view inherits from `str, Enum` instead of `UpperCaseStrEnum` with `auto()` values

Description: In `apps/claude_web_view/imbue/claude_web_view/models.py:9-14`, `MessageRole` inherits from `str, Enum` with hardcoded string values instead of `UpperCaseStrEnum` with `auto()`:

```python
class MessageRole(str, Enum):
    USER = "user"
    ASSISTANT = "assistant"
    SYSTEM = "system"
```

This violates three style guide rules simultaneously: wrong base class, non-`auto()` values, and lowercase string values.

Recommendation: Change to inherit from `UpperCaseStrEnum` and use `auto()` for all values. Note: this may require updating serialization/deserialization logic that depends on the lowercase string values.

Decision: Accept

## 6. Volume interface uses `str` for path parameters instead of `pathlib.Path`

Description: The style guide states "Always use `pathlib.Path` instead of `str` for file paths." The entire Volume abstraction layer uses `str` for path parameters:

- `libs/mng/imbue/mng/interfaces/volume.py:29-77` - `BaseVolume` interface methods (`listdir`, `read_file`, `remove_file`, `remove_directory`, `scoped`) all take `path: str`.
- `libs/mng/imbue/mng/providers/modal/volume.py:27-90` - Modal volume implementation methods all take `path: str`.
- `libs/mng/imbue/mng/providers/local/volume.py:21-62` - Local volume implementation methods all take `path: str`.
- `libs/mng/imbue/mng/providers/docker/volume.py:92-154` - Docker volume implementation methods all take `path: str`.

This affects 20+ method signatures across the interface and all 3 implementations.

Recommendation: Change the interface to use `Path` and update all implementations. This is a larger change since it affects the entire volume abstraction, but it would bring it in line with the style guide and improve type safety.

Decision: Accept

## 7. Built-in exceptions raised directly instead of custom error types

Description: The style guide says "Never raise built-in Exceptions directly (except NotImplementedError)." Several locations raise `ValueError`, `RuntimeError`, or `TypeError` directly:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:349,353,355` - raises `ValueError` for upload spec parsing errors
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/cron_runner.py:51,154,228` - raises `RuntimeError` for missing env vars and command failures
- `libs/mng_schedule/imbue/mng_schedule/cli/add.py:181` - raises `TypeError` for unsupported provider type
- `apps/changelings/imbue/changelings/deploy/cron_runner.py:226,409` - raises `RuntimeError` for command failures

Note: `libs/imbue_common/imbue/imbue_common/primitives.py` raises `ValueError` in primitive constructors (lines 14, 35, 55, 75, 95), but these are low-level validation in the base library where custom error types may be intentionally avoided for simplicity.

Recommendation: Replace built-in exception raises with custom error types that inherit from both the library's base error class and the relevant built-in exception (e.g., `class ScheduleDeployValueError(ScheduleDeployError, ValueError)`).

Decision: Accept

## 8. Blanket `except Exception:` catches instead of narrow exception types

Description: The style guide states "Always catch the narrowest specific exception type." Four locations use blanket `except Exception:`:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/verification.py:278`
- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:233`
- `apps/changelings/imbue/changelings/deploy/verification.py:182`
- `apps/claude_web_view/imbue/claude_web_view/watcher.py:35`

Recommendation: Replace with specific exception types. For cleanup/teardown code where truly any exception should be caught, consider at minimum logging the exception details.

Decision: Accept

## 9. FrozenModel classes scattered across many files instead of consolidated in data_types.py

Description: The style guide says "Frozen objects should be contained in a file named `data_types.py` at the root of the package." There are 40+ FrozenModel classes spread across non-data_types files. The most notable clusters are:

- `libs/mng/imbue/mng/interfaces/host.py` - 12 FrozenModel classes (CreateWorkDirResult, AgentGitOptions, AgentEnvironmentOptions, AgentLifecycleOptions, AgentLabelOptions, AgentPermissionsOptions, UploadFileSpec, FileModificationSpec, AgentProvisioningOptions, NamedCommand, AgentDataOptions, CreateAgentOptions)
- `libs/mng/imbue/mng/api/*.py` - 8 FrozenModel classes spread across exec.py, find.py, list.py, logs.py, sync.py
- `libs/mng/imbue/mng/cli/*.py` - 10 FrozenModel classes spread across common_opts.py, create.py, destroy.py, help_formatter.py, issue_reporting.py, plugin.py

Recommendation: Gradually migrate FrozenModel classes to data_types.py files in their respective packages. For the interfaces/ package, the many FrozenModel classes in host.py could be moved to interfaces/data_types.py. This is a significant refactoring effort and should be done incrementally to avoid large, risky changes.

Decision: Accept

## 10. Missing `@pure` decorator on pure functions

Description: The style guide says "All pure functions should be marked with the `@pure` decorator." Several functions that are clearly pure (no side effects, just data transformations) are missing the decorator:

- `libs/mng/imbue/mng/hosts/common.py:38` - `get_activity_sources_for_idle_mode` (maps enum to tuple)
- `libs/mng/imbue/mng/utils/terminal.py:16` - `ansi_cursor_up` (generates ANSI string)
- `libs/mng/imbue/mng/providers/docker/instance.py:116` - `build_container_labels` (builds dict)
- `libs/mng/imbue/mng/providers/docker/instance.py:132` - `parse_container_labels` (parses dict)
- `libs/mng/imbue/mng/providers/modal/instance.py:158` - `build_sandbox_tags` (builds tags dict)
- `libs/mng/imbue/mng/providers/modal/instance.py:181` - `parse_sandbox_tags` (parses tags dict)

Recommendation: Add `@pure` decorator to these functions.

Decision: Accept
