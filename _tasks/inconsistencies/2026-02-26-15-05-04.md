# Inconsistencies identified on 2026-02-26-15-05-04

## 1. `model_copy(update={...})` used instead of type-safe `model_copy_update(to_update(...))`

Description: The style guide mandates using the type-safe `model_copy_update(to_update(...))` pattern instead of raw string dictionaries with `model_copy(update={...})`. Three production files violate this:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:715` -- `trigger.model_copy(update={"git_image_hash": head_hash})`
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:726` -- `trigger.model_copy(update={"git_image_hash": commit_hash})`
- `apps/changelings/imbue/changelings/cli/add.py:135` -- `definition.model_copy(update={"mng_profile": resolved_profile})`

Recommendation: Replace all three with `model_copy_update(to_update(obj.field_ref().field_name, value))`.

Decision: Accept

## 2. `claude_web_view` app does not follow project conventions (enum, model, import style)

Description: The `apps/claude_web_view/` app has multiple style violations that make it inconsistent with the rest of the codebase:

- `apps/claude_web_view/imbue/claude_web_view/models.py:9` -- `MessageRole(str, Enum)` inherits from `str, Enum` with hardcoded string values instead of `UpperCaseStrEnum` with `auto()`.
- `apps/claude_web_view/imbue/claude_web_view/models.py:18-92` -- All model classes inherit from `BaseModel` instead of `FrozenModel`.
- `apps/claude_web_view/imbue/claude_web_view/cli.py:10`, `parser.py:6-12`, `server.py:15-16`, `watcher.py:8` -- 11 relative imports (`from .models import ...`, etc.) instead of absolute imports.

Recommendation: Convert `MessageRole` to use `UpperCaseStrEnum` with `auto()`. Convert all `BaseModel` subclasses to `FrozenModel`. Convert all relative imports to absolute imports (`from imbue.claude_web_view.models import ...`).

Decision: Accept

## 3. `config/data_types.py` exceeds 500-line threshold (751 lines)

Description: The style guide says "If `data_types.py` becomes too large (> 500 lines), split it out into a `data_types` module." The file `libs/mng/imbue/mng/config/data_types.py` is 751 lines, well over the 500-line threshold.

Recommendation: Convert to a `data_types/` module. Natural split points: config types (`MngConfig`, `LoggingConfig`, etc.) in one file, value types (`EnvVar`, `HookDefinition`, etc.) in another, and context types (`MngContext`, `OutputOptions`) in a third.

Decision: Accept

## 4. FrozenModel subclasses defined in `interfaces/host.py` instead of `data_types.py`

Description: The style guide says "Frozen objects should be contained in a file named `data_types.py`." The file `libs/mng/imbue/mng/interfaces/host.py` (764 lines) contains 12 FrozenModel subclasses that should be in `data_types.py` (or an `interfaces/data_types.py` sub-module): `CreateWorkDirResult` (line 460), `AgentGitOptions` (470), `AgentEnvironmentOptions` (516), `AgentLifecycleOptions` (529), `AgentLabelOptions` (543), `AgentPermissionsOptions` (552), `UploadFileSpec` (561), `FileModificationSpec` (576), `AgentProvisioningOptions` (591), `NamedCommand` (620), `AgentDataOptions` (674), `CreateAgentOptions` (687).

Recommendation: Move all FrozenModel classes from `interfaces/host.py` to `interfaces/data_types.py` (which would then need to be split into a `data_types/` module, as it is already at 534 lines).

Decision: Accept

## 5. Inconsistent boolean field naming: missing `is_` prefix on internal data types

Description: The style guide says "Always prefix internal boolean variables with `is_`." Several internal FrozenModel fields use boolean names without the `is_` prefix, while adjacent fields in the same codebase do use it:

- `libs/mng/imbue/mng/interfaces/data_types.py:182` -- `success: bool` on `CommandResult` (should be `is_success`)
- `libs/mng/imbue/mng/api/exec.py:34` -- `success: bool` on `ExecResult` (should be `is_success`)
- `libs/mng/imbue/mng/interfaces/data_types.py:463` -- `start_on_boot: bool` on `AgentInfo` (should be `is_start_on_boot`; compare with `AgentLifecycleOptions.is_start_on_boot` on line 537 of host.py)
- `libs/mng/imbue/mng/config/data_types.py:251` -- `enabled: bool` on `PluginConfig` (should be `is_enabled`; compare with `ProviderInstanceConfig.is_enabled` on line 202)

Recommendation: Rename to `is_success`, `is_start_on_boot`, and `is_enabled` for consistency with the rest of the codebase and the style guide.

Decision: Accept

## 6. Interface classes defined outside `interfaces.py`

Description: The style guide says "If you are creating an interface class, create it in a file named `interfaces.py`." Two ABC + MutableModel interface classes are defined in non-interface files:

- `libs/mng/imbue/mng/cli/ask.py:182` -- `ClaudeBackendInterface(MutableModel, ABC)`
- `libs/mng/imbue/mng/api/sync.py:135` -- `GitContextInterface(MutableModel, ABC)`

Recommendation: Move these interface classes to `interfaces/` (e.g., `interfaces/claude_backend.py` and `interfaces/git_context.py`, or add them to existing interface files).

Decision: Accept

## 7. Built-in exceptions raised directly in `mng_schedule` and `changelings`

Description: The style guide says "Never raise built-in Exceptions directly (except NotImplementedError)." Multiple files raise `ValueError`, `RuntimeError`, and `TypeError` directly:

- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/deploy.py:349,353,355` -- `raise ValueError(...)` (3 instances)
- `libs/mng_schedule/imbue/mng_schedule/implementations/modal/cron_runner.py:51,154,228` -- `raise RuntimeError(...)` (3 instances)
- `libs/mng_schedule/imbue/mng_schedule/cli/add.py:180` -- `raise TypeError(...)`
- `apps/changelings/imbue/changelings/deploy/cron_runner.py:226,409` -- `raise RuntimeError(...)` (2 instances)

Recommendation: Create library-specific error classes (e.g., `ScheduleDeployError` already exists and is used elsewhere in the same file -- use it consistently). For `changelings`, create a `ChangelingError` base class if one doesn't exist.

Decision: Accept

## 8. `_ListIterationParams` in `cli/list.py` uses `BaseModel` instead of `FrozenModel`

Description: `libs/mng/imbue/mng/cli/list.py:739` defines `_ListIterationParams(BaseModel)`. All non-mutable data classes in the project should inherit from `FrozenModel`, not bare `BaseModel`.

Recommendation: Change to inherit from `FrozenModel` instead of `BaseModel`. If mutability is needed, use `MutableModel`.

Decision: Accept

## 9. `num_fds` parameter name in `scripts/warm_cli_example.py`

Description: The style guide says "Avoid using `num`. Prefer `count` or `idx` instead." `scripts/warm_cli_example.py:49` defines `def _recv_fds(sock, num_fds):` with a `num` prefix.

Recommendation: Rename to `fd_count`.

Decision: Accept

## 10. `ClaudeAgentConfig` boolean fields inconsistent with `is_` prefix convention

Description: Within `ClaudeAgentConfig` (libs/mng/imbue/mng/agents/default_plugins/claude_agent.py:66-101), all boolean fields lack the `is_` prefix (`sync_home_settings`, `sync_claude_json`, `sync_repo_settings`, `sync_claude_credentials`, `convert_macos_credentials`, `check_installation`). While user-facing config fields are exempt from the `is_` prefix requirement, these fields are inconsistent with how other config fields in the same codebase are named (e.g., `is_enabled`, `is_logging_commands`, `is_nested_tmux_allowed` in `MngConfig`). This inconsistency between config classes creates confusion about the naming convention.

Recommendation: Consider renaming to `is_sync_home_settings`, `is_sync_claude_json`, etc. for consistency with other config boolean fields in the codebase, or document an explicit convention for when `is_` is vs. isn't used on config fields.

Decision: Accept

## 11. `TimeoutError` (built-in) raised directly in `utils/polling.py`

Description: `libs/mng/imbue/mng/utils/polling.py:67` raises the built-in `TimeoutError` directly: `raise TimeoutError(error_message)`. The style guide says to create library-specific error types. The project already has `CommandTimeoutError(HostError)` in `errors.py`, but a general-purpose `MngTimeoutError` doesn't exist.

Recommendation: Create a `PollingTimeoutError(BaseMngError, TimeoutError)` in `errors.py` and use it in `polling.py`.

Decision: Accept

## 12. Inline imports in production code

Description: Several production files contain inline imports (imports inside functions) which the style guide says should be removed:

- `libs/concurrency_group/imbue/concurrency_group/subprocess_utils.py:44` -- `from imbue.concurrency_group.errors import ProcessError`
- `apps/changelings/imbue/changelings/deploy/deploy.py:433` -- `from imbue.changelings.deploy.verification import verify_deployment`
- `apps/claude_web_view/imbue/claude_web_view/cli.py:109,112` -- `import threading`, `import time`
- `apps/sculptor_web/imbue/sculptor_web/main.py:513` -- `import uvicorn`

Note: `libs/mng/imbue/mng/interfaces/agent.py:29-31` uses `TYPE_CHECKING` with an explicit comment marking it as the only acceptable use, so it is excluded.

Recommendation: Move all inline imports to module level. For circular import issues, restructure the modules rather than using inline imports.

Decision: Accept
