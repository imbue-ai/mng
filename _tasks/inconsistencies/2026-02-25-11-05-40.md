# Inconsistencies identified on 2026-02-25-11-05-40

## 1. Constants declared without `Final` type annotation

Description: The style guide requires all constants to be declared with `Final` from `typing`. Multiple UPPER_CASE constants across the codebase are missing this annotation:

- `libs/mngr/imbue/mngr/providers/modal/instance.py:98` - `CONTAINER_SSH_PORT = 22`
- `libs/mngr/imbue/mngr/providers/modal/instance.py:100` - `DEFAULT_SANDBOX_TIMEOUT = 2 * 60`
- `libs/mngr/imbue/mngr/providers/modal/instance.py:102` - `SSH_CONNECT_TIMEOUT = 60`
- `libs/mngr/imbue/mngr/providers/modal/backend.py:39` - `MODAL_BACKEND_NAME = ProviderBackendName("modal")`
- `libs/mngr/imbue/mngr/providers/modal/backend.py:40` - `STATE_VOLUME_SUFFIX = "-state"`
- `libs/mngr/imbue/mngr/providers/modal/backend.py:41` - `MODAL_NAME_MAX_LENGTH = 64`
- `libs/mngr/imbue/mngr/providers/modal/constants.py:3` - `MODAL_TEST_APP_PREFIX = "mngr-test-"`
- `libs/mngr/imbue/mngr/providers/ssh/backend.py:29` - `SSH_BACKEND_NAME = ProviderBackendName("ssh")`
- `libs/mngr/imbue/mngr/providers/local/backend.py:14` - `LOCAL_BACKEND_NAME = ProviderBackendName("local")`
- `libs/mngr/imbue/mngr/cli/common_opts.py:33` - `COMMON_OPTIONS_GROUP_NAME = "Common"`
- `libs/mngr/imbue/mngr/config/data_types.py:34` - `USER_ID_FILENAME = "user_id"`
- `libs/mngr/imbue/mngr/config/data_types.py:35` - `PROFILES_DIRNAME = "profiles"`
- `libs/mngr/imbue/mngr/config/data_types.py:36` - `ROOT_CONFIG_FILENAME = "config.toml"`
- `libs/mngr/imbue/mngr/providers/modal/routes/snapshot_and_shutdown.py:47` - `VOLUME_NAME`

By contrast, some constants in the same codebase correctly use `Final` (e.g., `TAG_HOST_ID: Final[str]` at `modal/instance.py:107`). This inconsistency makes it unclear which constants are truly intended to be immutable.

Recommendation: Add `Final[<type>]` annotations to all UPPER_CASE constants. A project-wide search for `^[A-Z_]+ =` patterns would identify all instances.

Decision: Accept

## 2. Dictionary/mapping fields not following `value_by_key` naming convention

Description: The style guide requires dictionary and mapping fields to use the `value_by_key` naming pattern (e.g., `todo_list_by_list_id`). Several dictionary-typed fields in data models use plural names instead:

- `libs/mngr/imbue/mngr/config/data_types.py:417` - `agent_types: dict[AgentTypeName, AgentTypeConfig]` (should be `agent_type_config_by_name`)
- `libs/mngr/imbue/mngr/config/data_types.py:421` - `providers: dict[ProviderInstanceName, ProviderInstanceConfig]` (should be `provider_config_by_name`)
- `libs/mngr/imbue/mngr/config/data_types.py:425` - `plugins: dict[PluginName, PluginConfig]` (should be `plugin_config_by_name`)
- `libs/mngr/imbue/mngr/config/data_types.py:433` - `commands: dict[str, CommandDefaults]` (should be `command_defaults_by_name`)
- `libs/mngr/imbue/mngr/config/data_types.py:437` - `create_templates: dict[CreateTemplateName, CreateTemplate]` (should be `create_template_by_name`)
- `libs/mngr/imbue/mngr/config/data_types.py:441` - `pre_command_scripts: dict[str, list[str]]` (should be `pre_command_scripts_by_command_name`)
- `libs/mngr/imbue/mngr/providers/registry.py:29` - `_backend_registry: dict[...]` (should be `_backend_class_by_name`)
- `libs/mngr/imbue/mngr/providers/registry.py:31` - `_config_registry: dict[...]` (should be `_config_class_by_backend_name`)
- `libs/mngr/imbue/mngr/agents/agent_registry.py:23` - `_agent_class_registry: dict[...]` (should be `_agent_class_by_type_name`)
- `libs/mngr/imbue/mngr/agents/agent_registry.py:24` - `_agent_config_registry: dict[...]` (should be `_agent_config_class_by_type_name`)

Recommendation: Rename these fields to follow the `value_by_key` convention. Since `MngrConfig` fields are used in TOML config files, renaming them will require a config migration or deprecation period. The registry module-level dicts are private and can be renamed freely.

Decision: Accept

## 3. Direct raising of built-in `Exception` class

Description: The style guide says "Never raise built-in Exceptions directly (except NotImplementedError)." Two places raise the bare `Exception` class:

- `libs/mngr/imbue/mngr/providers/modal/instance.py:607` - `raise Exception(f"Host record not found on volume for {host_id}")`
- `libs/mngr/imbue/mngr/providers/modal/backend.py:452` - `raise Exception("Host is not an instance of Host class")`

These should use library-specific error types from `imbue.mngr.errors` (or a new `ModalProviderError` subclass).

Recommendation: Create specific error types (e.g., `HostRecordNotFoundError`, `InvalidHostTypeError`) that inherit from both `MngrError` and the appropriate built-in exception, then use those instead.

Decision: Accept

## 4. Boolean fields missing `is_` prefix

Description: The style guide requires boolean fields to be prefixed with `is_` (unless they are CLI arguments or attributes directly corresponding to CLI args). Several data model fields violate this:

- `libs/mngr/imbue/mngr/config/data_types.py:242` - `enabled: bool` in `PluginConfig` (should be `is_enabled`)
- `libs/mngr/imbue/mngr/interfaces/data_types.py:173` - `success: bool` in `CommandResult` (should be `is_success`)
- `libs/mngr/imbue/mngr/api/data_types.py:281` - `create_work_dir: bool` in `CreateOptions` (should be `is_create_work_dir`)
- `libs/mngr/imbue/mngr/api/list.py:63` - `start_on_boot: bool` in `AgentInfo` (should be `is_start_on_boot`)
- `libs/mngr/imbue/mngr/agents/default_plugins/claude_agent.py:51` - `sync_home_settings: bool` in `ClaudeAgentConfig`
- `libs/mngr/imbue/mngr/agents/default_plugins/claude_agent.py:55` - `sync_claude_json: bool` in `ClaudeAgentConfig`
- `libs/mngr/imbue/mngr/agents/default_plugins/claude_agent.py:59` - `sync_repo_settings: bool` in `ClaudeAgentConfig`
- `libs/mngr/imbue/mngr/agents/default_plugins/claude_agent.py:63` - `sync_claude_credentials: bool` in `ClaudeAgentConfig`
- `libs/mngr/imbue/mngr/agents/default_plugins/claude_agent.py:72` - `check_installation: bool` in `ClaudeAgentConfig`

Note: The `ClaudeAgentConfig` fields are used in TOML config files, so renaming them may require migration support.

Recommendation: Add the `is_` prefix to these boolean fields. For config-file-facing fields, consider adding a TOML alias for backward compatibility during transition.

Decision: Accept

## 5. Use of `NamedTuple` instead of `FrozenModel`

Description: The style guide says "Never use dataclasses or named tuples." Two classes use `NamedTuple`:

- `libs/mngr/imbue/mngr/utils/logging.py:232` - `class BufferedMessage(NamedTuple)` with fields `formatted_message: str` and `is_stderr: bool`
- `libs/mngr/imbue/mngr/conftest.py:537` - `class ModalSubprocessTestEnv(NamedTuple)` with fields `env`, `prefix`, `host_dir`

These should inherit from `FrozenModel` instead.

Recommendation: Convert both classes to inherit from `FrozenModel` with appropriate `Field` declarations. The `BufferedMessage` in `logging.py` is the more important one to fix since it's production code (the conftest one is test infrastructure).

Decision: Accept

## 6. Inline import in production code

Description: The style guide says "You may use inline imports when initially generating code, but remove them during the testing phase." One inline import exists in production code:

- `libs/concurrency_group/imbue/concurrency_group/subprocess_utils.py:44` - `from imbue.concurrency_group.errors import ProcessError` inside the `check()` method of `FinishedProcess`

Recommendation: Move this import to the top of the file with the other imports.

Decision: Accept

## 7. `TimeoutError` raised directly without library-specific wrapper

Description: The style guide says "Never raise built-in Exceptions directly (except NotImplementedError)." The polling utility raises `TimeoutError` directly:

- `libs/mngr/imbue/mngr/utils/polling.py:58` - `raise TimeoutError(error_message)`

Additionally in the concurrency_group library:
- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:636` - `raise ValueError("The exception group does not contain exactly one exception.")`

Recommendation: For `polling.py`, create a `PollingTimeoutError(MngrError, TimeoutError)` that inherits from both the library base error and `TimeoutError`. For `concurrency_group.py`, create a `ConcurrencyGroupValueError(ConcurrencyGroupError, ValueError)`.

Decision: Accept

## 8. Overly broad `except Exception:` clause

Description: The style guide says "Always catch the narrowest specific exception type" and "Never use a blanket `except:` clause." One place uses a broad `except Exception:`:

- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:233` - `except Exception: pass` when joining threads

The `Thread.join()` method can raise `RuntimeError` in specific cases (e.g., joining the current thread). The catch here should be narrowed.

Recommendation: Replace `except Exception:` with `except RuntimeError:` (the specific exception that `Thread.join()` can raise), or add a comment explaining why the broad catch is necessary if there are edge cases that require it.

Decision: Accept

## 9. If/elif chains missing final `else` clause in concurrency_group

Description: The style guide states "All if/elif chains must end with an else clause." Two if/elif chains in the `_cleanup_finished_strands` method are missing else clauses:

- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:477-485` - Thread cleanup filter: `if tracked_thread.thread.is_alive() ... elif (tracked_thread.is_checked ...` with no `else`
- `libs/concurrency_group/imbue/concurrency_group/concurrency_group.py:486-495` - Process cleanup filter: `if not process.is_finished() ... elif (process.is_checked ...` with no `else`

These are filtering operations where items not matching either condition are intentionally dropped, but the style guide requires an explicit `else` clause (which could just contain `pass`).

Recommendation: Add explicit `else: pass` clauses with a brief comment (e.g., `# Finished, checked, and non-failed strands are dropped`) to make the intent clear per the style guide.

Decision: Accept

## 10. `async` method in production code

Description: The style guide says "Never use `async` or `asyncio`." One async method exists:

- `libs/mngr/imbue/mngr/providers/modal/log_utils.py:154` - `async def put_log_content(self, log):` in `ModalLoguruWriter`

This method overrides a Modal library method that requires an async signature, so it may be a necessary exception. However, it is still a deviation from the style guide.

Recommendation: Document this as an accepted exception with a comment explaining that the async signature is required by the Modal SDK's `OutputManager` interface. Consider whether there's a synchronous alternative in the Modal API.

Decision: Accept
