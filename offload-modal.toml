# offload configuration for running mngr tests on Modal
[offload]
max_parallel = 100
test_timeout_secs = 60
retry_count = 4
stream_output = true

[provider]
type = "default"
prepare_command = "uv run @modal_sandbox.py prepare --cached libs/mngr/imbue/mngr/resources/Dockerfile"
create_command = "uv run @modal_sandbox.py create {image_id}" #g Image Id gets injected, also --copy-dirs
exec_command = "uv run @modal_sandbox.py exec {sandbox_id} {command}"
destroy_command = "uv run @modal_sandbox.py destroy {sandbox_id}"
timeout_secs = 600

[groups.all]
type = "default"
# Discover tests locally using pytest --collect-only, exclude acceptance and release tests
discover_command = "uv run pytest --collect-only -q -m 'not acceptance and not release' 2>/dev/null | grep '::'"
# Run tests in the sandbox (source is baked into /app)
run_command = "cd /code/mngr && git apply /offload-upload/patch --allow-empty && uv sync --all-packages && uv run pytest -v --tb=short --no-cov -p no:xdist -o addopts= {tests}"

[report]
output_dir = "test-results"
junit = true
junit_file = "junit.xml"
