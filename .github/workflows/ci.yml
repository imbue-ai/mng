name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ['**']

jobs:
  # Integration tests with coverage - runs on non-main branches
  test-integration:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run tests
        run: uv run pytest -n 0 --timeout 10 --cov-fail-under=0 -v --tb=short --splits 4 --group ${{ matrix.group }} --splitting-algorithm=least_duration

      - name: List coverage files
        run: |
          echo "Coverage files created:"
          ls -lhta

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.group }}
          path: .coverage
          include-hidden-files: true
          retention-days: 1

  coverage:
    if: github.ref != 'refs/heads/main'
    needs: test-integration
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*

      - name: List coverage files
        run: |
          echo "Coverage files created:"
          ls -lhta

      - name: Combine coverage
        run: |
          uv run coverage combine coverage-*/.coverage
          uv run coverage report --fail-under=80
          uv run coverage xml
          uv run coverage html

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  # Coverage warning job - shows yellow indicator if coverage is below 81%
  # This is separate from the hard 80% threshold to provide early warning
  coverage-warning:
    if: github.ref != 'refs/heads/main'
    needs: test-integration
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*

      - name: Check coverage threshold (81% warning)
        run: |
          uv run coverage combine coverage-*/.coverage
          uv run coverage report --fail-under=81

  # Clean up old Modal test environments - runs before acceptance tests
  cleanup-modal-environments:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Clean up old Modal test environments
        run: uv run python scripts/cleanup_old_modal_test_environments.py --max-age-hours 1.0


  # Acceptance tests - runs on all branches (except main, since release tests are a superset)
  test-acceptance:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4, 5, 6, 7, 8]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run acceptance tests
        run: export IS_ACCEPTANCE=1 && uv run pytest -n 0 --timeout 90 --override-ini='addopts=-n 0 -m "not release"' --no-cov -v --tb=short --splits 8 --group ${{ matrix.group }} --splitting-algorithm=least_duration

  # Create Modal agent - runs on non-main branches to test Modal agent creation
  create-modal-agent:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Prepare build context for Modal
        run: |
          # Use GITHUB_SHA for the commit hash in CI
          ./scripts/make_tar_of_repo.sh "$GITHUB_SHA" .mngr/dev/build

      - name: Destroy existing agent (idempotent)
        run: uv run mngr destroy modal-ci-test-1 -f || true

      - name: Create Modal agent
        run: |
          uv run mngr create modal-ci-test-1 -vv \
            --idle-timeout 60 \
            --in github_modal \
            --target-path /code/mngr \
            --no-ensure-clean \
            --no-connect \
            -- --dangerously-skip-permissions

      - name: Verify agent was created
        run: |
          uv run mngr list --format json | tee agent_list.json
          # Check that our agent appears in the list
          if grep -q "modal-ci-test-1" agent_list.json; then
            echo "Agent modal-ci-test-1 was successfully created"
          else
            echo "ERROR: Agent modal-ci-test-1 not found in agent list"
            exit 1
          fi

  # Release tests - runs only on main branch pushes
  test-release:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4, 5, 6, 7, 8]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run release tests
        run: export IS_RELEASE=1 && uv run pytest -n 0 --timeout 90 --override-ini='addopts=-n 0' --no-cov -v --tb=short --splits 8 --group ${{ matrix.group }} --splitting-algorithm=least_duration
