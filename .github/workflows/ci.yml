name: CI

on:
  push:
    branches: [release, main]
  pull_request:
    branches: ['**']

jobs:
  # Integration tests with coverage - runs on non-release branches
  test-integration:
    if: github.ref != 'refs/heads/release'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server unison

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run tests
        run: uv run pytest -n 0 --timeout 10 --cov-fail-under=0 -v --tb=short --splits 4 --group ${{ matrix.group }} --splitting-algorithm=least_duration

      - name: Upload test timing data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-durations-integration-${{ matrix.group }}
          path: .test_output/test_durations_*.json
          retention-days: 30

      - name: List coverage files
        run: |
          echo "Coverage files created:"
          ls -lhta

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.group }}
          path: .coverage
          include-hidden-files: true
          retention-days: 1

  coverage:
    if: github.ref != 'refs/heads/release'
    needs: test-integration
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*

      - name: List coverage files
        run: |
          echo "Coverage files created:"
          ls -lhta

      - name: Combine coverage
        run: |
          uv run coverage combine coverage-*/.coverage
          uv run coverage report --fail-under=80
          uv run coverage xml
          uv run coverage html

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  # Coverage warning job - shows yellow indicator if coverage is below 81%
  # This is separate from the hard 80% threshold to provide early warning
  coverage-warning:
    if: github.ref != 'refs/heads/release'
    needs: test-integration
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*

      - name: Check coverage threshold (81% warning)
        run: |
          uv run coverage combine coverage-*/.coverage
          uv run coverage report --fail-under=81

  # Clean up old Modal test environments - runs on all branches including release,
  # since both acceptance tests (non-release) and release tests (release) create environments.
  cleanup-modal-environments:
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Clean up old Modal test environments
        run: uv run python scripts/cleanup_old_modal_test_environments.py --max-age-hours 1.0


  # Acceptance tests - runs on all branches (except release, since release tests are a superset)
  test-acceptance:
    if: github.ref != 'refs/heads/release'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server unison

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run acceptance tests
        run: export IS_ACCEPTANCE=1 && uv run pytest -n 0 --timeout 90 --override-ini='addopts=-n 0 -m "acceptance"' --no-cov -v --tb=short --durations=0 --splits 16 --group ${{ matrix.group }} --splitting-algorithm=least_duration

      - name: Upload test timing data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-durations-acceptance-${{ matrix.group }}
          path: .test_output/test_durations_*.json
          retention-days: 30

  # Release tests - runs only on release branch pushes
  test-release:
    if: github.ref == 'refs/heads/release' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      MODAL_TOKEN_ID: ${{ vars.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git openssh-server unison

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Run release tests
        run: export IS_RELEASE=1 && uv run pytest -n 0 --timeout 90 --override-ini='addopts=-n 0' --no-cov -v --tb=short --splits 12 --group ${{ matrix.group }} --splitting-algorithm=least_duration

      - name: Upload test timing data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-durations-release-${{ matrix.group }}
          path: .test_output/test_durations_*.json
          retention-days: 30
